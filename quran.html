<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المصحف الإلكتروني | خُطىْ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #1e3a8a;
            --gold: #c9a227;
            --gold-light: #e6c84c;
            --cream: #f5f0e6;
            --paper: #faf8f3;
            --ink: #1a1a1a;
            --border-tan: #c4b59a;
            --verse-number: #1e3a8a;
            --highlight-gold: #b8860b;
        }

        /* الثيمات */
        [data-theme="cream"] {
            --navy: #1e3a8a;
            --gold: #c9a227;
            --gold-light: #e6c84c;
            --cream: #f5f0e6;
            --paper: #faf8f3;
            --ink: #1a1a1a;
            --border-tan: #c4b59a;
            --verse-number: #1e3a8a;
            --highlight-gold: #b8860b;
        }

        [data-theme="dark"] {
            --navy: #1e3a8a;
            --gold: #fbbf24;
            --gold-light: #fcd34d;
            --cream: #1f2937;
            --paper: #111827;
            --ink: #f3f4f6;
            --border-tan: #4b5563;
            --verse-number: #60a5fa;
            --highlight-gold: #d4a574;
        }

        [data-theme="green"] {
            --navy: #065f46;
            --gold: #059669;
            --gold-light: #10b981;
            --cream: #ecfdf5;
            --paper: #f0fdf4;
            --ink: #064e3b;
            --border-tan: #6ee7b7;
            --verse-number: #059669;
            --highlight-gold: #047857;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Noto Naskh Arabic', 'Tajawal', serif;
            background: var(--cream);
            color: var(--ink);
            min-height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-y;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            opacity: 0.35;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        /* الفوتر - شريط سفلي رسمي بسيط */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 0.35rem 0.5rem;
            background: rgba(250,248,243,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(196,181,154,0.3);
        }
        .footer-inner {
            max-width: 768px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.35rem;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.4rem;
            color: var(--navy);
            text-decoration: none;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            font-size: 0.7rem;
            border-radius: 0.4rem;
            background: rgba(30,58,138,0.08);
        }
        .footer-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.05rem;
        }
        .page-indicator {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--navy);
        }
        .sura-juz {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.7rem;
            color: var(--navy);
            opacity: 0.8;
        }
        .footer-nav {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--navy);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
        }
        .nav-btn:active { transform: scale(0.92); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .nav-btn svg { width: 16px; height: 16px; }
        .nav-btn.next svg { transform: scaleX(-1); }

        /* زر تغيير الثيم */
        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--navy);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
            position: relative;
        }
        .theme-btn:active { transform: scale(0.92); }
        .theme-btn svg { width: 16px; height: 16px; }

        /* منطقة القراءة - كامل الشاشة بدون مشتتات */
        .reading-area {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 42px;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            padding: 0;
        }
        .page-view {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--paper);
            padding: 0.5rem 8px 0.5rem 8px;
            margin: 0 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* نقوش إسلامية مصحفية - يمين ويسار */
        .page-view::before,
        .page-view::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 24px;
            z-index: 0;
            opacity: 0.5;
            background-repeat: repeat-y;
            background-size: 24px 32px;
        }
        .page-view::before {
            right: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='32' viewBox='0 0 24 32'%3E%3Cpath fill='none' stroke='%23c4b59a' stroke-width='0.5' d='M12 0v6M12 26v6M4 16h6M14 16h6M7 7l3.5 3.5M13.5 12.5l3.5 3.5M7 25l3.5-3.5M13.5 19.5l3.5-3.5M17 7l-3.5 3.5M3.5 12.5L0 16M17 25l-3.5-3.5M3.5 19.5L0 16'/%3E%3Ccircle cx='12' cy='16' r='3' fill='none' stroke='%23c4b59a' stroke-width='0.45'/%3E%3Cpath fill='none' stroke='%23c9a227' stroke-width='0.4' opacity='0.8' d='M12 10 Q16 16 12 22 Q8 16 12 10'/%3E%3C/svg%3E");
        }
        .page-view::after {
            left: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='32' viewBox='0 0 24 32'%3E%3Cpath fill='none' stroke='%23c4b59a' stroke-width='0.5' d='M12 0v6M12 26v6M4 16h6M14 16h6M7 7l3.5 3.5M13.5 12.5l3.5 3.5M7 25l3.5-3.5M13.5 19.5l3.5-3.5M17 7l-3.5 3.5M3.5 12.5L0 16M17 25l-3.5-3.5M3.5 19.5L0 16'/%3E%3Ccircle cx='12' cy='16' r='3' fill='none' stroke='%23c4b59a' stroke-width='0.45'/%3E%3Cpath fill='none' stroke='%23c9a227' stroke-width='0.4' opacity='0.8' d='M12 10 Q16 16 12 22 Q8 16 12 10'/%3E%3C/svg%3E");
        }
        .ornament.ornament-top,
        .ornament.ornament-bottom {
            position: absolute;
            left: 0;
            right: 0;
            height: 24px;
            z-index: 0;
            opacity: 0.5;
            background-repeat: repeat-x;
            background-size: 32px 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='24' viewBox='0 0 32 24'%3E%3Cpath fill='none' stroke='%23c4b59a' stroke-width='0.5' d='M16 0v6M16 24v6M10 12h6M22 12h6M12 5l3.5 3.5M16.5 9.5l3.5 3.5M12 19l3.5-3.5M16.5 14.5l3.5-3.5M22 5l-3.5 3.5M5.5 9.5L2 12M22 19l-3.5-3.5M5.5 14.5L2 12'/%3E%3Ccircle cx='16' cy='12' r='3' fill='none' stroke='%23c4b59a' stroke-width='0.45'/%3E%3Cpath fill='none' stroke='%23c9a227' stroke-width='0.4' opacity='0.8' d='M16 8 Q20 12 16 16 Q12 12 16 8'/%3E%3C/svg%3E");
        }
        .ornament.ornament-top { top: 0; }
        .ornament.ornament-bottom { bottom: 0; }
        .page-view-inner {
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 32px 0;
            overflow: hidden;
        }
        .page-view-inner .page-content {
            padding: 0 26px;
        }
        .page-view .basmala,
        .page-view .page-content {
            position: relative;
            z-index: 1;
        }
        .page-view .basmala {
            text-align: center;
            font-size: clamp(0.85rem, 2.3vh, 1.05rem);
            line-height: 1.5;
            color: var(--ink);
            margin-bottom: 0.25rem;
            flex-shrink: 0;
        }
        .page-content {
            flex: 1;
            font-size: clamp(0.85rem, 2.3vh, 1.15rem);
            line-height: 1.8;
            text-align: justify;
            color: var(--ink);
            overflow: hidden;
        }
        .page-content .aya-wrap {
            display: inline;
        }
        .page-content .aya-wrap::after {
            content: "\00A0";
        }
        .aya-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.65em;
            height: 1.65em;
            line-height: 1;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.65em;
            font-weight: 700;
            color: var(--verse-number);
            background: transparent;
            border: none;
            border-radius: 50%;
            margin-left: 0.35rem;
            margin-right: 0.35rem;
            vertical-align: middle;
            box-shadow: 0 0 0 1.5px rgba(196,181,154,0.75),
                        0 0 0 3px rgba(196,181,154,0.35);
        }

        /* تمييز لفظ الجلالة */
        .allah-highlight {
            color: #dc2626;
            font-weight: 600;
        }

        /* وضع التركيز العميق */
        .app-footer.auto-hide {
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .app-footer.auto-show {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        
        /* شريط التقدم اليومي */
        .daily-progress-bar {
            position: fixed;
            top: auto;
            bottom: 42px;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(196,181,154,0.2);
            z-index: 99;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 1rem;
        }
        .daily-progress-fill {
            height: 100%;
            background: var(--gold);
            transition: width 0.5s ease;
            border-radius: 0 3px 3px 0;
            flex: 1;
        }
        .daily-progress-label {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--navy);
            background: var(--paper);
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            z-index: 1;
            white-space: nowrap;
        }

        /* تظليل الآية المحددة */
        .verse-highlighted {
            background: rgba(0, 0, 0, 0.08);
            border-radius: 0.25rem;
            padding: 0.1rem 0.2rem;
            margin: 0 -0.2rem;
        }
        [data-theme="dark"] .verse-highlighted {
            background: rgba(255, 255, 255, 0.1);
        }

        /* شريط الأزرار السريع */
        .verse-action-bar {
            position: fixed;
            bottom: -100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--paper);
            border: 1px solid var(--border-tan);
            border-radius: 2rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 1002;
            transition: bottom 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
        .verse-action-bar.show {
            bottom: 60px;
        }
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--navy);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
            font-size: 0.8rem;
        }
        .action-btn:hover {
            transform: scale(1.1);
            background: var(--gold);
        }
        .action-btn:active {
            transform: scale(0.95);
        }
        .action-btn svg {
            width: 14px;
            height: 14px;
        }
        /* نافذة التفسير المنبثقة */
        .verse-insight {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: var(--paper);
            border-top: 2px solid var(--border-tan);
            border-radius: 1rem 1rem 0 0;
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 1001;
            transition: bottom 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .verse-insight {
            background: #1f2937;
            border-top-color: #6b7280;
        }
        .verse-insight.show {
            bottom: 0;
        }
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-tan);
        }
        [data-theme="dark"] .insight-header {
            border-bottom-color: #6b7280;
        }
        .insight-title {
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            color: var(--navy);
            font-size: 0.9rem;
        }
        .insight-close {
            background: none;
            border: none;
            color: var(--navy);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .insight-close:hover {
            background: rgba(196,181,154,0.2);
        }
        .insight-content {
            font-family: 'Noto Naskh Arabic', serif;
            line-height: 1.8;
            color: var(--ink);
            font-size: 0.9rem;
        }
        .insight-verse {
            color: var(--navy);
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(196,181,154,0.1);
            border-radius: 0.5rem;
        }
        [data-theme="dark"] .insight-verse {
            background: rgba(107,114,128,0.2);
        }
        .insight-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-tan);
        }
        [data-theme="dark"] .insight-actions {
            border-top-color: #6b7280;
        }
        .insight-action-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-tan);
            background: var(--paper);
            color: var(--navy);
            border-radius: 0.5rem;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        [data-theme="dark"] .insight-action-btn {
            background: #374151;
            border-color: #6b7280;
            color: #f3f4f6;
        }
        .insight-action-btn:hover {
            background: var(--gold);
            color: white;
        }

        /* التحميل */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            padding: 2rem;
            text-align: center;
        }
        .loading-state .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(30,58,138,0.2);
            border-top-color: var(--navy);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state p {
            margin-top: 1rem;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            color: var(--navy);
        }
    </style>
</head>
<body>
    <!-- شريط التقدم اليومي -->
    <div class="daily-progress-bar" id="dailyProgressBar">
        <div class="daily-progress-fill" id="dailyProgressFill"></div>
        <div class="daily-progress-label">الورد اليومي</div>
    </div>

    <main class="reading-area" id="readingArea">
        <div class="loading-state" id="loadingState">
            <div class="spinner"></div>
            <p>جاري تحميل المصحف...</p>
        </div>
        <div class="page-view" id="pageView" style="display: none;">
            <div class="ornament ornament-top" aria-hidden="true"></div>
            <div class="ornament ornament-bottom" aria-hidden="true"></div>
            <div class="page-view-inner" id="pageViewInner"></div>
        </div>
    </main>

    <!-- نافذة التفسير المنبثقة -->
    <div class="verse-insight" id="verseInsight">
        <div class="insight-header">
            <div class="insight-title">تفسير الآية</div>
            <button class="insight-close" id="insightClose">×</button>
        </div>
        <div class="insight-content">
            <div class="insight-verse" id="insightVerse"></div>
            <div id="insightText">جاري تحميل التفسير...</div>
        </div>
        <div class="insight-actions">
            <button class="insight-action-btn" id="copyVerseBtn">نسخ الآية</button>
            <button class="insight-action-btn" id="copyWithTafseerBtn">نسخ مع التفسير</button>
            <button class="insight-action-btn" id="shareWhatsAppBtn">مشاركة واتساب</button>
        </div>
    </div>

    <!-- شريط الأزرار السريع -->
    <div class="verse-action-bar" id="verseActionBar">
        <button class="action-btn" id="copyBtn" title="نسخ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
        </button>
        <button class="action-btn" id="tafseerBtn" title="تفسير">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/>
            </svg>
        </button>
        <button class="action-btn" id="favoriteBtn" title="المفضلة">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
        </button>
        <button class="action-btn" id="shareBtn" title="مشاركة">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>
            </svg>
        </button>
    </div>

    <footer class="app-footer" id="appFooter">
        <div class="footer-inner">
            <a href="index.html" class="back-link">← رجوع</a>
            <div class="footer-nav">
                <button type="button" class="theme-btn" id="themeBtn" title="تغيير الثيم">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                </button>
                <button type="button" class="nav-btn" id="btnPrev" title="السابقة">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <button type="button" class="nav-btn" id="btnNext" title="التالية">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
            <div class="footer-meta">
                <span class="page-indicator" id="pageIndicator">ص —</span>
                <span class="sura-juz" id="suraJuz"></span>
            </div>
        </div>
    </footer>

    <script>
        (function() {
            const STORAGE_KEY_PAGE = 'quran_last_page';
            const STORAGE_KEY_SURA = 'quran_last_sura_name';
            const STORAGE_KEY_THEME = 'quran_theme';
            const TOTAL_PAGES = 604;
            const BASMALA = 'بِسۡمِ ٱللَّهِ ٱلرَّحۡمَٰنِ ٱلرَّحِيمِ';
            const SWIPE_THRESHOLD = 60;

            const THEMES = ['cream', 'dark', 'green'];
            let currentThemeIndex = 0;

            let pagesMap = {};
            let currentPageNum = 1;
            let dailyStartPage = 1;
            let dailyPages = 22;
            let touchStartX = 0;

            const loadingState = document.getElementById('loadingState');
            const pageView = document.getElementById('pageView');
            const pageViewInner = document.getElementById('pageViewInner');
            const pageIndicator = document.getElementById('pageIndicator');
            const suraJuzEl = document.getElementById('suraJuz');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const themeBtn = document.getElementById('themeBtn');
            const appFooter = document.getElementById('appFooter');
            const dailyProgressBar = document.getElementById('dailyProgressBar');
            const dailyProgressFill = document.getElementById('dailyProgressFill');
            const verseInsight = document.getElementById('verseInsight');
            const insightClose = document.getElementById('insightClose');
            const insightVerse = document.getElementById('insightVerse');
            const insightText = document.getElementById('insightText');
            const verseActionBar = document.getElementById('verseActionBar');
            const copyBtn = document.getElementById('copyBtn');
            const tafseerBtn = document.getElementById('tafseerBtn');
            const favoriteBtn = document.getElementById('favoriteBtn');
            const shareBtn = document.getElementById('shareBtn');
            const copyVerseBtn = document.getElementById('copyVerseBtn');
            const copyWithTafseerBtn = document.getElementById('copyWithTafseerBtn');
            const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');

            // متغيرات وضع التركيز العميق
            let lastScrollTop = 0;
            let scrollTimeout;
            let isFooterVisible = true;

            // متغيرات التفسير
            let lastTapTime = 0;
            let tappedVerse = null;
            let currentVerseText = '';
            let currentVerseNumber = '';
            let currentTafseer = '';

            function loadTheme() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_THEME);
                    if (saved && THEMES.includes(saved)) {
                        currentThemeIndex = THEMES.indexOf(saved);
                    } else {
                        currentThemeIndex = 0;
                    }
                } catch (_) {
                    currentThemeIndex = 0;
                }
                applyTheme();
            }

            function saveTheme() {
                try {
                    localStorage.setItem(STORAGE_KEY_THEME, THEMES[currentThemeIndex]);
                } catch (_) {}
            }

            function applyTheme() {
                document.body.setAttribute('data-theme', THEMES[currentThemeIndex]);
            }

            function switchTheme() {
                currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
                applyTheme();
                saveTheme();
            }

            // وضع التركيز العميق
            function initDeepFocusMode() {
                pageView.addEventListener('scroll', function() {
                    const currentScrollTop = pageView.scrollTop;
                    
                    if (currentScrollTop > lastScrollTop && currentScrollTop > 50) {
                        // التمرير لأسفل - إخفاء الفوتر
                        if (isFooterVisible) {
                            appFooter.classList.add('auto-hide');
                            appFooter.classList.remove('auto-show');
                            isFooterVisible = false;
                        }
                    } else if (currentScrollTop < lastScrollTop - 10) {
                        // التمرير لأعلى - إظهار الفوتر
                        if (!isFooterVisible) {
                            appFooter.classList.add('auto-show');
                            appFooter.classList.remove('auto-hide');
                            isFooterVisible = true;
                        }
                    }
                    
                    lastScrollTop = currentScrollTop;
                    
                    // إلغاء التايمر السابق
                    clearTimeout(scrollTimeout);
                    
                    // إخفاء الفوتر بعد التوقف عن التمرير
                    scrollTimeout = setTimeout(function() {
                        if (currentScrollTop > 50) {
                            appFooter.classList.add('auto-hide');
                            appFooter.classList.remove('auto-show');
                            isFooterVisible = false;
                        }
                    }, 2000);
                });
            }

            
            // تحديث شريط التقدم اليومي
            function updateDailyProgress() {
                const todayEnd = Math.min(dailyStartPage + dailyPages - 1, TOTAL_PAGES);
                const totalInPlan = todayEnd - dailyStartPage + 1;
                let done = 0;
                
                if (currentPageNum >= dailyStartPage && currentPageNum <= todayEnd) {
                    done = currentPageNum - dailyStartPage + 1;
                } else if (currentPageNum > todayEnd) {
                    done = totalInPlan;
                }
                
                const ratio = totalInPlan > 0 ? done / totalInPlan : 0;
                const percentage = ratio * 100;
                
                dailyProgressFill.style.width = percentage + '%';
                
                // اهتزاز عند إكمال الورد
                if (done === totalInPlan && navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            }

            // التفسير اللحظي
            function showVerseInsight(verseText, verseNumber) {
                currentVerseText = verseText;
                currentVerseNumber = verseNumber;
                
                insightVerse.textContent = `الآية ${verseNumber}: ${verseText.substring(0, 100)}...`;
                
                // محاكاة التفسير (يمكن استبداله ببيانات حقيقية)
                const tafseerTexts = [
                    "هذه الآية تتحدث عن أهمية الإيمان والعمل الصالح.",
                    "في هذه الآية بيان لرحمة الله الواسعة بعباده.",
                    "هذه الآية توضح الحكمة من خلق الإنسان والكون.",
                    "في هذه الآية دعوة للتأمل في آيات الله في الطبيعة.",
                    "هذه الآية ترشد إلى الصراط المستقيم وطرق الهداية."
                ];
                
                currentTafseer = tafseerTexts[Math.floor(Math.random() * tafseerTexts.length)];
                insightText.textContent = currentTafseer;
                
                verseInsight.classList.add('show');
            }

            function hideVerseInsight() {
                verseInsight.classList.remove('show');
                // لا إخفاء شريط الأزرار هنا
            }

            function showActionBar() {
                verseActionBar.classList.add('show');
            }

            function hideActionBar() {
                verseActionBar.classList.remove('show');
            }

            // وظائف الأزرار
            function copyVerse() {
                const fullText = `${currentVerseText} [${currentVerseNumber}]`;
                navigator.clipboard.writeText(fullText).then(() => {
                    alert('تم نسخ الآية بنجاح');
                });
            }

            function copyWithTafseer() {
                const fullText = `${currentVerseText} [${currentVerseNumber}]\n\nالتفسير: ${currentTafseer}`;
                navigator.clipboard.writeText(fullText).then(() => {
                    alert('تم نسخ الآية مع التفسير بنجاح');
                });
            }

            function shareWhatsApp() {
                const fullText = `${currentVerseText} [${currentVerseNumber}]\n\nالتفسير: ${currentTafseer}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(fullText)}`;
                window.open(whatsappUrl, '_blank');
            }

            function loadPlan() {
                try {
                    const saved = localStorage.getItem('quranPlanV3');
                    if (saved) {
                        const plan = JSON.parse(saved);
                        dailyPages = plan.dailyPages || 22;
                        const day = plan.currentDay || 1;
                        dailyStartPage = 1 + (day - 1) * dailyPages;
                    }
                } catch (_) {}
            }

            function savePosition(pageNum) {
                if (pageNum < 1 || pageNum > TOTAL_PAGES) return;
                localStorage.setItem(STORAGE_KEY_PAGE, String(pageNum));
                const verses = pagesMap[pageNum];
                if (verses && verses.length > 0) {
                    const name = verses[0].sura_name_ar ? verses[0].sura_name_ar.trim() : '';
                    if (name) localStorage.setItem(STORAGE_KEY_SURA, name);
                }
            }

            function getLastPage() {
                const p = parseInt(localStorage.getItem(STORAGE_KEY_PAGE), 10);
                return (p >= 1 && p <= TOTAL_PAGES) ? p : 1;
            }

            function buildPagesMap(data) {
                const byPage = {};
                data.forEach(function(aya) {
                    const p = aya.page;
                    if (!byPage[p]) byPage[p] = [];
                    byPage[p].push(aya);
                });
                Object.keys(byPage).forEach(function(p) {
                    byPage[p].sort(function(a, b) {
                        return (a.line_start - b.line_start) || (a.aya_no - b.aya_no);
                    });
                });
                return byPage;
            }

            function escapeHtml(s) {
                if (!s) return '';
                const div = document.createElement('div');
                div.textContent = s;
                return div.innerHTML;
            }

            /** إزالة رموز الوقف (عرض عربي U+FB00–FDFF) واختصارات الوقف في نهاية الآية (سم، سح، ضج...) */
            function cleanAyaText(text) {
                if (!text || typeof text !== 'string') return '';
                var out = '';
                for (var i = 0; i < text.length; i++) {
                    var code = text.charCodeAt(i);
                    if (code >= 0xFB00 && code <= 0xFDFF) continue;
                    if (code === 0x06DE || code === 0x0773 || code === 0x0774 || code === 0x06DD) continue;
                    out += text.charAt(i);
                }
                out = out.trim().replace(/\s+/g, ' ');
                out = out.replace(/\s*س\s*م\s*$/g, '').replace(/\s*س\s*ح\s*$/g, '').replace(/\s*ض\s*ج\s*$/g, '');
                out = out.replace(/\s*(?:سم|سح|ضج|قلي|صل)\s*$/g, '');
                return out.trim();
            }

            function highlightAllah(text) {
                return text.replace(/الله/g, '<span class="allah-highlight">الله</span>');
            }

            function renderCurrentPage() {
                const verses = pagesMap[currentPageNum];
                if (!verses || verses.length === 0) {
                    pageViewInner.innerHTML = '';
                    return;
                }

                const first = verses[0];
                const showBasmala = first.aya_no === 1 && first.sura_no > 1;

                let html = '';
                if (showBasmala) {
                    html += '<p class="basmala">' + highlightAllah(escapeHtml(BASMALA)) + '</p>';
                }
                html += '<div class="page-content">';
                verses.forEach(function(v, index) {
                    const cleanText = cleanAyaText(v.aya_text);
                    const verseId = `verse-${currentPageNum}-${index}`;
                    html += '<span class="aya-wrap" id="' + verseId + '" data-verse="' + v.aya_no + '" data-text="' + escapeHtml(cleanText.substring(0, 100)) + '">' + 
                            highlightAllah(escapeHtml(cleanText)) + 
                            '<span class="aya-num">' + v.aya_no + '</span></span>';
                });
                html += '</div>';

                pageViewInner.innerHTML = html;

                // إضافة مستمع النقر المزدوج للتفسير فقط
                setTimeout(function() {
                    const verseElements = pageViewInner.querySelectorAll('.aya-wrap');
                    verseElements.forEach(function(verse) {
                        verse.addEventListener('click', function(e) {
                            const currentTime = new Date().getTime();
                            const tapLength = currentTime - lastTapTime;
                            
                            if (tapLength < 300 && tapLength > 0) {
                                // نقر مزدوج
                                e.preventDefault();
                                const verseNumber = this.getAttribute('data-verse');
                                const verseText = this.getAttribute('data-text');
                                
                                // تظليل الآية
                                if (tappedVerse && tappedVerse !== this) {
                                    tappedVerse.classList.remove('verse-highlighted');
                                }
                                this.classList.add('verse-highlighted');
                                tappedVerse = this;
                                
                                // تخزين بيانات الآية الحالية
                                currentVerseText = verseText;
                                currentVerseNumber = verseNumber;
                                
                                // إظهار شريط الأزرار فقط
                                showActionBar();
                                
                                // إخفاء نافذة التفسير إذا كانت ظاهرة
                                hideVerseInsight();
                            }
                            
                            lastTapTime = currentTime;
                            tappedVerse = this;
                        });
                    });
                }, 100);
            }

            function updateUI() {
                pageIndicator.textContent = 'ص ' + currentPageNum;
                btnPrev.disabled = currentPageNum <= 1;
                btnNext.disabled = currentPageNum >= TOTAL_PAGES;

                var verses = pagesMap[currentPageNum];
                if (verses && verses.length > 0) {
                    var first = verses[0];
                    var suraName = first.sura_name_ar ? first.sura_name_ar.trim() : '';
                    var juz = first.jozz || first.juzz || '';
                    suraJuzEl.textContent = (suraName ? suraName + ' · ' : '') + (juz ? 'جزء ' + juz : '');
                } else {
                    suraJuzEl.textContent = '';
                }

                // تحديث شريط التقدم اليومي
                updateDailyProgress();

                const todayEnd = Math.min(dailyStartPage + dailyPages - 1, TOTAL_PAGES);
                if (currentPageNum === todayEnd + 1 && navigator.vibrate) {
                    navigator.vibrate([20, 50, 20]);
                }
            }

            function goToPage(pageNum) {
                if (pageNum < 1 || pageNum > TOTAL_PAGES) return;
                currentPageNum = pageNum;
                savePosition(currentPageNum);
                renderCurrentPage();
                updateUI();
            }

            function goPrev() {
                if (currentPageNum > 1) goToPage(currentPageNum - 1);
            }

            function goNext() {
                if (currentPageNum < TOTAL_PAGES) goToPage(currentPageNum + 1);
            }

            function onSwipe(deltaX) {
                if (deltaX > SWIPE_THRESHOLD) goPrev();
                else if (deltaX < -SWIPE_THRESHOLD) goNext();
            }

            pageView.addEventListener('touchstart', function(e) {
                touchStartX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
            }, { passive: true });
            pageView.addEventListener('touchend', function(e) {
                const x = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : e.clientX;
                onSwipe(x - touchStartX);
            }, { passive: true });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight') goPrev();
                else if (e.key === 'ArrowLeft') goNext();
            });

            fetch('assets/quran.json')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    loadPlan();
                    loadTheme();
                    pagesMap = buildPagesMap(data);
                    loadingState.style.display = 'none';
                    pageView.style.display = 'block';

                    currentPageNum = getLastPage();
                    renderCurrentPage();
                    updateUI();

                    // تهيئة الميزات الإبداعية
                    initDeepFocusMode();

                    // مستمعو الأحداث
                    btnPrev.addEventListener('click', goPrev);
                    btnNext.addEventListener('click', goNext);
                    themeBtn.addEventListener('click', switchTheme);
                    insightClose.addEventListener('click', hideVerseInsight);
                    
                    // أزرار شريط الأدوات
                    copyBtn.addEventListener('click', copyVerse);
                    tafseerBtn.addEventListener('click', function() {
                        hideActionBar(); // إخفاء شريط الأزرار
                        showVerseInsight(currentVerseText, currentVerseNumber); // إظهار نافذة التفسير
                    });
                    favoriteBtn.addEventListener('click', function() {
                        alert('تمت إضافة الآية إلى المفضلة');
                    });
                    shareBtn.addEventListener('click', shareWhatsApp);
                    
                    // أزرار نافذة التفسير
                    copyVerseBtn.addEventListener('click', copyVerse);
                    copyWithTafseerBtn.addEventListener('click', copyWithTafseer);
                    shareWhatsAppBtn.addEventListener('click', shareWhatsApp);
                    
                    // إغلاق التفسير عند النقر خارج النافذة
                    verseInsight.addEventListener('click', function(e) {
                        if (e.target === verseInsight) {
                            hideVerseInsight();
                        }
                    });
                    
                    // إغلاق شريط الأزرار عند النقر في أي مكان آخر
                    document.addEventListener('click', function(e) {
                        if (!verseActionBar.contains(e.target) && !e.target.closest('.aya-wrap') && !verseInsight.contains(e.target)) {
                            hideActionBar();
                            // إزالة التظليل عند إغلاق شريط الأزرار
                            if (tappedVerse) {
                                tappedVerse.classList.remove('verse-highlighted');
                                tappedVerse = null;
                            }
                        }
                    });
                })
                .catch(function(err) {
                    loadingState.innerHTML = '<p style="color:#b91c1c;">فشل تحميل المصحف. تأكد من وجود ملف assets/quran.json</p>';
                    console.error(err);
                });
        })();
    </script>
</body>
</html>
