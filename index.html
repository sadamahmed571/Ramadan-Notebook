<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>خُطىْ V3.0 | مفكرة رمضانية</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <!-- External Lists -->
    <script src="js/wisdom.js"></script>
    <script src="js/ideas.js"></script>
    <script src="js/quiz.js"></script>
    <script src="js/hydration-data.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    },
                    colors: {
                        navy: '#1e3a8a',
                        gold: '#fbbf24',
                        offwhite: '#f8fafc',
                        emerald: '#10b981',
                        'oled-black': '#121212', // ✅ Deep charcoal for OLED comfort
                        'sunset-orange': '#f97316',
                        'deep-indigo': '#312e81',
                        serenity: '#10b981',
                    },
                    animation: {
                        'shake': 'shake 0.82s cubic-bezier(.36,.07,.19,.97) both',
                        'fill-up': 'fillUp 0.5s ease-out forwards',
                        'pulse-glow': 'pulse-gold 1.8s infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fillUp: {
                            '0%': { transform: 'scaleY(0)' },
                            '100%': { transform: 'scaleY(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            background-color: #f8fafc;
            position: relative;
            min-height: 100vh;
        }

        /* 🎨 Arabic Geometric Background Pattern */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 0l4.5 35.5L80 40l-35.5 4.5L40 80l-4.5-35.5L0 40l35.5-4.5L40 0z' fill='%231e3a8a' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-size: 80px 80px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }


        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .animate-pulse-gold {
            animation: pulse-gold 1.5s infinite;
        }

        .cup-content {
            transform-origin: bottom;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-offwhite dark:bg-oled-black text-slate-800 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ---------- Ramadaan V3.0 - "خُطىْ" | Smart Planner with Privacy First ----------
        const { useState, useEffect, useMemo, useRef } = React;

        // -------------------- 🗄️ DATABASE INITIALIZATION --------------------
        const db = new Dexie("RamadanPlannerDB");
        db.version(1).stores({
            appState: "id, value",
            dailyProgress: "day, data"
        });

        // -------------------- 💾 HELPER FUNCTIONS --------------------
        const triggerConfetti = (fullScreen = false) => {
            if (fullScreen) {
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.5 }, colors: ['#fbbf24', '#1e3a8a', '#10b981'] });
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.5, x: 0.2 }, colors: ['#f97316', '#312e81'] });
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.5, x: 0.8 }, colors: ['#10b981', '#fbbf24'] });
            } else {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#1e3a8a', '#10b981'] });
            }
        };
        const triggerHaptic = (style = 'light') => {
            if (navigator.vibrate) {
                if (style === 'light') navigator.vibrate(10);
                if (style === 'medium') navigator.vibrate(20);
                if (style === 'heavy') navigator.vibrate([30, 50, 30]);
                if (style === 'success') navigator.vibrate([10, 30, 10, 30]);
            }
        };

        // -------------------- 📅 CONSTANTS & DATASETS --------------------
        // 🕋 صلاة مواقيت (تجريبية)
        const PRAYER_TIMES = [
            { id: 'fajr', name: 'الفجر', time: '05:00', timeEn: '05:00' },
            { id: 'dhuhr', name: 'الظهر', time: '12:30', timeEn: '12:30' },
            { id: 'asr', name: 'العصر', time: '15:45', timeEn: '15:45' },
            { id: 'maghrib', name: 'المغرب', time: '18:30', timeEn: '18:30' },
            { id: 'isha', name: 'العشاء', time: '20:00', timeEn: '20:00' }
        ];


        // -------------------- 🧩 ONBOARDING MODAL (الترحيب والخصوصية) --------------------
        const OnboardingModal = ({ onClose }) => {
            const [name, setName] = useState('');
            useEffect(() => { lucide.createIcons(); });

            const handleStart = () => {
                onClose(name.trim());
            };

            return (
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
                    <div class="glass-card rounded-2xl max-w-sm w-full p-6 text-right animate-fade-in shadow-[0_20px_50px_rgba(0,0,0,0.2)]">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gold/20 rounded-full flex items-center justify-center">
                                    <i data-lucide="heart-handshake" class="w-5 h-5 text-gold"></i>
                                </div>
                                <h2 class="text-lg font-bold text-navy">أهلاً بك في خُطىْ</h2>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 leading-relaxed mb-6">
                            نود تنبيهك أن بياناتك محفوظة محلياً بالكامل على جهازك لضمان خصوصيتك.
                        </p>

                        <div class="mb-6">
                            <label class="block text-[11px] font-bold text-gray-400 mb-2 uppercase tracking-widest">ماذا نلقبك؟ (اختياري)</label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="مثلاً: صداموز"
                                class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl text-sm focus:ring-2 focus:ring-gold outline-none transition-all"
                            />
                        </div>

                        <button onClick={handleStart} class="w-full bg-navy hover:bg-navy/90 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-navy/20 transition-all active:scale-95">
                            لنبدأ
                        </button>
                    </div>
                </div>
            );
        };

        // -------------------- 🕌 ويدجت الحكمة والهوية --------------------
        const WisdomWidget = ({ hijriDay = 12 }) => {
            const [wisdom, setWisdom] = useState({ text: '', author: '' });
            useEffect(() => {
                // عرض حكمة واحدة محددة لكل يوم من أيام رمضان
                const index = (hijriDay - 1) % WISDOM_ARRAY.length;
                setWisdom(WISDOM_ARRAY[index]);
                lucide.createIcons();
            }, [hijriDay]);

            const shareWhatsApp = () => {
                const message = `"${wisdom.text}"${wisdom.author ? ` - ${wisdom.author}` : ''}\n\nتمت المشاركة من تطبيق خُطىْ 🌙`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const copyToClipboard = () => {
                const text = `"${wisdom.text}"${wisdom.author ? ` - ${wisdom.author}` : ''}`;
                navigator.clipboard.writeText(text).then(() => {
                    alert('تم نسخ الحكمة بنجاح!');
                });
            };

            return (
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-col items-center justify-center gap-3 border-t-4 border-t-gold text-center">
                    <div>
                        <p class="text-sm font-bold text-gray-700 dark:text-gray-200 leading-relaxed">
                            "{wisdom.text}"
                        </p>
                        {wisdom.author && (
                            <p class="text-[11px] text-gray-500 dark:text-gray-400 font-medium mt-1">
                                {wisdom.author}
                            </p>
                        )}
                    </div>

                    <div class="flex gap-3 mt-1">
                        <button onClick={shareWhatsApp} class="flex items-center gap-1.5 px-3 py-1 bg-emerald/10 text-emerald rounded-full hover:bg-emerald/20 transition text-[10px] font-bold">
                            <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>

                        </button>
                        <button onClick={copyToClipboard} class="flex items-center gap-1.5 px-3 py-1 bg-navy/10 text-navy dark:bg-gold/10 dark:text-gold rounded-full hover:bg-navy/20 dark:hover:bg-gold/20 transition text-[10px] font-bold">
                            <i data-lucide="copy" class="w-3.5 h-3.5"></i>

                        </button>
                    </div>
                </div>
            );
        };

        // -------------------- 🕋 الهيدر المتطور + جدول الصلاة (تمييز القادم) --------------------
        const SmartLunarHeader = ({ hijriDay = 12 }) => {
            const [prayers, setPrayers] = useState(PRAYER_TIMES);
            const [nextPrayer, setNextPrayer] = useState(null);
            const [timeLeft, setTimeLeft] = useState("00:00:00");
            const [currentTime, setCurrentTime] = useState("");
            const [isFasting, setIsFasting] = useState(true);

            useEffect(() => {
                // Fetch dynamic prayer times
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const { latitude, longitude } = position.coords;
                        fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=4`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.code === 200) {
                                    const t = data.data.timings;
                                    const dynamic = [
                                        { id: 'fajr', name: 'الفجر', time: t.Fajr, timeEn: t.Fajr },
                                        { id: 'dhuhr', name: 'الظهر', time: t.Dhuhr, timeEn: t.Dhuhr },
                                        { id: 'asr', name: 'العصر', time: t.Asr, timeEn: t.Asr },
                                        { id: 'maghrib', name: 'المغرب', time: t.Maghrib, timeEn: t.Maghrib },
                                        { id: 'isha', name: 'العشاء', time: t.Isha, timeEn: t.Isha }
                                    ];
                                    setPrayers(dynamic);
                                }
                            })
                            .catch(err => console.error("Prayer API Error:", err));
                    });
                }
            }, []);

            useEffect(() => {
                const updateTimer = () => {
                    const now = new Date();
                    const currentTotal = now.getHours() * 60 + now.getMinutes();
                    const currentSecs = now.getSeconds();

                    // Live Local Clock
                    setCurrentTime(now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }));

                    const prayerMins = prayers.map(p => {
                        const [h, m] = p.time.split(':').map(Number);
                        return { ...p, total: h * 60 + m };
                    }).sort((a, b) => a.total - b.total);

                    let next = prayerMins.find(p => p.total > currentTotal);
                    if (!next) next = prayerMins[0];
                    setNextPrayer(next.id);

                    // صيام: من الفجر حتى المغرب
                    const fajrTotal = prayerMins.find(p => p.id === 'fajr').total;
                    const maghribTotal = prayerMins.find(p => p.id === 'maghrib').total;
                    const fasting = (currentTotal >= fajrTotal && currentTotal < maghribTotal);
                    setIsFasting(fasting);

                    // الهدف: المغرب إذا صائم، الفجر إذا مفطر
                    let targetTotal;
                    if (fasting) {
                        targetTotal = maghribTotal;
                    } else {
                        targetTotal = currentTotal >= maghribTotal ? fajrTotal + 1440 : fajrTotal;
                    }

                    let diffSecs = (targetTotal * 60) - (currentTotal * 60 + currentSecs);
                    const h = Math.floor(diffSecs / 3600);
                    const m = Math.floor((diffSecs % 3600) / 60);
                    const s = diffSecs % 60;
                    setTimeLeft(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                };

                updateTimer();
                const interval = setInterval(updateTimer, 1000);
                lucide.createIcons();
                return () => clearInterval(interval);
            }, []);

            return (
                <div class={`relative rounded-2xl p-4 mb-3 overflow-hidden text-white shadow-lg transition-all duration-500 ${isFasting ? 'bg-gradient-to-r from-sunset-orange to-red-600' : 'bg-gradient-to-r from-deep-indigo to-navy'}`}>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide={isFasting ? "sunset" : "moon"} class="w-4 h-4 text-white/80"></i>
                                <span class="text-xs font-medium opacity-90">{isFasting ? "المتبقي للإفطار" : "المتبقي للإمساك"}</span>
                            </div>
                            <h2 class="text-3xl font-bold tracking-tight">{timeLeft}</h2>
                            <span class="text-[12px] block opacity-80 mt-1">{currentTime}</span>
                        </div>
                        <div class="text-center bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm min-w-[75px]">
                            <i data-lucide="moon-star" class="w-7 h-7 mx-auto"></i>
                            <span class="text-[13px] block mt-1 font-bold">{hijriDay} رمضان</span>
                        </div>
                    </div>

                    {/* 🕌 جدول الصلاة المصغر */}
                    <div class="mt-3 grid grid-cols-5 gap-1 text-[10px] bg-black/20 rounded-xl p-2 backdrop-blur-sm">
                        {prayers.map((prayer) => (
                            <div key={prayer.id} class={`text-center rounded-lg p-1 transition ${nextPrayer === prayer.id ? 'bg-gold/30 text-white scale-105' : ''}`}>
                                <span class="block font-bold">{prayer.name}</span>
                                <span class="block text-[10px] opacity-90">{prayer.time}</span>
                            </div>
                        ))}
                    </div>

                    <div class="absolute -top-6 -left-6 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                    <div class="absolute -bottom-6 -right-6 w-32 h-32 bg-gold/20 rounded-full blur-xl"></div>
                </div>
            );
        };

        // -------------------- 🏋️ المتتبع اليومي (صلوات + إضافة تراويح وتهجد) --------------------
        const DailyTrackerV3 = ({ items, onItemToggle, onAddHabit, onRemoveHabit, isLongPressMode, longPressActive }) => {
            const timerRef = useRef(null);
            const [localLongPress, setLocalLongPress] = useState(false);

            useEffect(() => { lucide.createIcons(); });

            const startPress = () => {
                timerRef.current = setTimeout(() => {
                    setLocalLongPress(true);
                    longPressActive(true);
                    triggerHaptic('heavy');
                }, 800);
            };
            const endPress = () => {
                clearTimeout(timerRef.current);
                if (localLongPress) setLocalLongPress(false);
            };

            return (
                <div class="mb-3">
                    <div class="flex justify-between items-end mb-2 px-1">
                        <h3 class="font-bold text-navy dark:text-gold text-sm flex items-center gap-1">
                            <i data-lucide="check-check" class="w-4 h-4"></i>
                            متتبع يومي للصلوات الخمس
                        </h3>

                        {isLongPressMode && <span class="text-[10px] text-red-500 animate-pulse">مسّ العلامة الحمراء للحذف</span>}
                    </div>
                    <div class="glass-card rounded-xl p-3">
                        <div class="grid grid-cols-4 gap-2 px-1">
                            {items.map((item) => (
                                <div
                                    key={item.id}
                                    class="relative"
                                >
                                    <button
                                        onTouchStart={startPress}
                                        onTouchEnd={endPress}
                                        onMouseDown={startPress}
                                        onMouseUp={endPress}
                                        onClick={() => !isLongPressMode && onItemToggle(item.id)}
                                        class={`relative flex flex-col items-center justify-center w-full h-14 rounded-xl transition-all duration-300 active:scale-90 ${isLongPressMode ? 'animate-shake' : ''
                                            } ${item.completed
                                                ? 'bg-navy dark:bg-emerald text-white shadow-lg ring-2 ring-navy/20 dark:ring-emerald/20'
                                                : 'bg-gray-50 dark:bg-white/5 text-gray-600 dark:text-gray-500 border border-transparent'
                                            }`}
                                    >
                                        {item.completed && (
                                            <div class="absolute top-1 right-1 w-3.5 h-3.5 bg-gold dark:bg-navy rounded-full flex items-center justify-center animate-bounce shadow-sm">
                                                <i data-lucide="check" class="w-2.5 h-2.5 text-navy dark:text-gold stroke-[4px]"></i>
                                            </div>
                                        )}
                                        <div class={`mb-0.5 transition-transform duration-300 ${item.completed ? 'scale-110' : ''}`}>
                                            {typeof item.icon === 'string' ? <i data-lucide={item.icon} class="w-4 h-4"></i> : item.icon}
                                        </div>
                                        <span class="text-[10px] font-medium">{item.label}</span>
                                    </button>
                                    {item.isAdditional && (
                                        <button
                                            onClick={(e) => { e.stopPropagation(); onRemoveHabit(item.id); }}
                                            class="absolute -top-1 -left-1 w-4 h-4 bg-gray-200 dark:bg-gray-700 text-gray-500 rounded-full flex items-center justify-center text-[8px] z-10 shadow-sm hover:bg-red-500 hover:text-white transition"
                                        >
                                            ✕
                                        </button>
                                    )}
                                </div>
                            ))}

                            {/* أزرار الإضافة السريعة: تراويح وقيام - يتم عرضها فقط إذا لم تكن مضافة بالفعل */}
                            {!items.find(i => i.id === 'taraweeh') && (
                                <button
                                    onClick={() => onAddHabit('taraweeh')}
                                    class="flex flex-col items-center justify-center h-14 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 text-gray-500 hover:text-gold transition"
                                >
                                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                                    <span class="text-[10px] mt-0.5">تراويح</span>
                                </button>
                            )}
                            {!items.find(i => i.id === 'qiyam') && (
                                <button
                                    onClick={() => onAddHabit('qiyam')}
                                    class="flex flex-col items-center justify-center h-14 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 text-gray-500 hover:text-gold transition"
                                >
                                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                                    <span class="text-[10px] mt-0.5">قيام</span>
                                </button>
                            )}
                        </div>
                        <p class="text-[9px] text-gray-400 mt-3 text-center">بامكانك اضافة صلوات التروايح و القيام او الغاء اضافتها في المتتبع</p>
                    </div>
                </div>
            );
        };

        // -------------------- 📖 نظام الورد القرآني الذكي --------------------
        // -------------------- 📖 نظام الورد القرآني الذكي --------------------
        const QuranAdvanced = ({ plan, onSetup }) => {
            const [showModal, setShowModal] = useState(false);
            const [dailyRead, setDailyRead] = useState(false); // حالة إنجاز اليوم
            const [lastRead, setLastRead] = useState(null);

            useEffect(() => {
                lucide.createIcons();
                setLastRead(localStorage.getItem('quran_last_sura_name'));
            });

            if (!plan) {
                return (
                    <div class="glass-card p-4 rounded-xl mb-3 text-center">
                        <i data-lucide="quran" class="w-8 h-8 mx-auto text-navy dark:text-gold mb-2"></i>
                        <p class="text-sm font-bold text-navy dark:text-white mb-2">
                            <i data-lucide="book-open-check" class="w-5 h-5 mx-auto opacity-50"></i>
                        </p>
                        <button
                            onClick={() => setShowModal(true)}
                            class="bg-navy hover:bg-navy/90 text-white px-6 py-2 rounded-lg text-xs   transition"
                        >
                            إعداد خطة الورد القرآني
                        </button>
                        {showModal && <QuranSetupModal onClose={(p) => { setShowModal(false); onSetup(p); }} />}
                    </div>
                );
            }

            // إذا الخطة موجودة
            const progressPercent = (plan.completedDays?.length || 0) / 30 * 100; // Updated to 30 days
            const totalPagesProgress = ((plan.completedDays?.length || 0) * plan.dailyPages) / plan.totalPages * 100;
            const todayCompleted = plan.completedDays?.includes(plan.currentDay) || false;

            return (
                <div class="glass-card p-4 rounded-xl mb-3 border-r-4 border-r-emerald bg-gradient-to-l from-emerald/5 to-white">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-navy text-sm flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-emerald"></i>
                            {plan.dailyPages} صفحة وردك اليومي
                        </h3>
                        <span class="text-[9px] font-bold bg-emerald text-white px-2 py-0.5 rounded-full">
                            {plan.completedDays?.length || 0}/30 يوم
                        </span>
                    </div>

                    {/* Visual  ختمة Progress */}
                    <div class="mt-3">
                        <div class="flex justify-between text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5">
                            <span>تقدم الختمة</span>
                            <span>{Math.min(100, Math.round(totalPagesProgress))}%</span>
                        </div>
                        <div class="relative h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                            <div class="absolute top-0 right-0 h-full bg-emerald shadow-[0_0_8px_rgba(16,185,129,0.4)] transition-all duration-1000 ease-out"
                                style={{ width: `${totalPagesProgress}%` }}></div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3 mt-4">
                        <div class="flex justify-between items-center bg-white/40 p-2 rounded-lg border border-gray-50">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400">سورة {lastRead || '...'}</span>
                                <span class="text-[10px] font-bold text-navy">تابع من حيث توقفت</span>
                            </div>
                            <button
                                onClick={() => {
                                    triggerHaptic('success');
                                    onSetup({ ...plan, completedDays: todayCompleted ? plan.completedDays.filter(d => d !== plan.currentDay) : [...(plan.completedDays || []), plan.currentDay] });
                                    if (!todayCompleted) triggerConfetti(false);
                                }}
                                class={`text-[11px] px-4 py-1.5 rounded-full transition-all font-bold flex items-center gap-1.5 shadow-sm ${todayCompleted ? 'bg-emerald text-white' : 'bg-navy text-white hover:scale-105 active:scale-95'}`}
                            >
                                <i data-lucide={todayCompleted ? "check-circle" : "circle"} class="w-3.5 h-3.5"></i>
                                {todayCompleted ? 'تمت القراءة' : 'أنهيت الورد'}
                            </button>
                        </div>
                        <a href="quran.html" class="w-full bg-navy/5 hover:bg-navy/10 text-navy py-2 rounded-lg text-[10px] font-bold transition flex items-center justify-center gap-2 border border-navy/5">
                            <i data-lucide="book-open-check" class="w-3.5 h-3.5"></i>
                            فتح المصحف الإلكتروني
                        </a>
                    </div>
                </div>
            );
        };

        // نافذة إعداد الخطة
        const QuranSetupModal = ({ onClose }) => {
            const [qurans, setQurans] = useState(1);
            const [custom, setCustom] = useState(false);
            const submit = () => {
                const totalPages = qurans * 604;
                const dailyPages = Math.ceil(totalPages / 28);
                const plan = {
                    totalQurans: qurans,
                    totalPages,
                    dailyPages,
                    currentDay: 12, // تجريبي
                    completedDays: []
                };
                onClose(plan);
            };
            return (
                <div class="fixed inset-0 z-40 flex items-center justify-center p-4 modal-backdrop">
                    <div class="glass-card rounded-2xl max-w-xs w-full p-5">
                        <h3 class="text-md font-bold text-navy dark:text-gold mb-3">كم مصحفاً تنوي ختمه؟</h3>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            {[1, 2, 3].map(n => (
                                <button key={n} onClick={() => { setQurans(n); setCustom(false); }} class={`py-2 rounded-lg border ${qurans === n && !custom ? 'bg-navy text-white border-navy' : 'bg-gray-100 dark:bg-gray-800'}`}>{n}</button>
                            ))}
                            <button onClick={() => setCustom(true)} class={`py-2 rounded-lg border ${custom ? 'bg-navy text-white' : 'bg-gray-100 dark:bg-gray-800'}`}>مخصص</button>
                        </div>
                        {custom && (
                            <div class="mb-4">
                                <label class="text-xs block mb-1">عدد المصاحف:</label>
                                <input type="number" min="1" value={qurans} onChange={(e) => setQurans(parseInt(e.target.value) || 1)} class="w-full p-2 bg-white dark:bg-gray-900 border rounded-lg text-sm" />
                            </div>
                        )}
                        <div class="flex gap-2">
                            <button onClick={submit} class="flex-1 bg-navy text-white py-2 rounded-lg text-sm">حفظ الخطة</button>
                            <button onClick={() => onClose(null)} class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded-lg text-sm">إلغاء</button>
                        </div>
                    </div>
                </div>
            );
        };

        // -------------------- ✨ بصمة الخير (الفكرة 2) --------------------
        const PersonalReflectionWidget = ({ userName }) => {
            const [idea, setIdea] = useState('');
            const [reflection, setReflection] = useState(() => localStorage.getItem('dailyReflectionV3') || '');

            useEffect(() => {
                setIdea(DAILY_IDEA_ARRAY[Math.floor(Math.random() * DAILY_IDEA_ARRAY.length)]);
                lucide.createIcons();
            }, []);

            const handleSave = (val) => {
                setReflection(val);
                localStorage.setItem('dailyReflectionV3', val);
            };

            return (
                <div class="glass-card p-4 rounded-xl mb-3 bg-gradient-to-br from-amber-50/40 to-white dark:from-gray-800 dark:to-gray-900 border border-gold/10">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 hide-element-on-print bg-gold/20 rounded-full flex items-center justify-center shrink-0">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-gold"></i>
                        </div>
                        <p class="text-[11px] font-bold text-navy dark:text-gold leading-tight">مقترح اليوم: <span class="font-medium text-gray-600 dark:text-gray-300">{idea}</span></p>
                    </div>

                    <div class="relative">
                        <textarea
                            value={reflection}
                            onChange={(e) => handleSave(e.target.value)}
                            placeholder={`ما هو الأثر الطيب الذي تركته اليوم يا ${userName || 'بطل'}؟`}
                            class="w-full p-3 bg-white/50 dark:bg-black/20 border border-gray-100 dark:border-white/5 rounded-lg text-xs min-h-[70px] focus:ring-1 focus:ring-gold outline-none resize-none transition-all placeholder:italic"
                        ></textarea>
                        <div class="absolute bottom-2 left-2 opacity-20">
                            <i data-lucide="pen-tool" class="w-3 h-3 text-navy"></i>
                        </div>
                    </div>
                </div>
            );
        };


        const SmartQuiz = ({ quizState, quizHistory, onAnswer, onNext, isDailyComplete, allCorrectToday, hijriDay = 12 }) => {
            const [timeLeft, setTimeLeft] = useState(10);
            const [timerActive, setTimerActive] = useState(false);
            const [timerEnabled, setTimerEnabled] = useState(false); // Default: Off

            useEffect(() => {
                if (!isDailyComplete && !quizState.feedbackGiven && timerEnabled) {
                    setTimeLeft(10);
                    setTimerActive(true);
                } else {
                    setTimerActive(false);
                }
            }, [quizState.currentIndex, isDailyComplete, quizState.feedbackGiven, timerEnabled]);

            useEffect(() => {
                let timer;
                if (timerActive && timeLeft > 0 && timerEnabled) {
                    timer = setInterval(() => {
                        setTimeLeft(prev => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0 && timerActive && timerEnabled) {
                    onAnswer(false);
                    setTimerActive(false);
                }
                return () => clearInterval(timer);
            }, [timeLeft, timerActive, timerEnabled]);

            useEffect(() => { lucide.createIcons(); });

            if (isDailyComplete) {
                const totalScore = Object.values(quizHistory).reduce((a, b) => a + b, 0);
                return (
                    <div class="glass-card p-6 rounded-xl shadow-lg border-2 border-gold/20">
                        <div class="flex flex-col items-center mb-6">
                            <i data-lucide="trophy" class="w-10 h-10 text-gold mb-3 animate-bounce"></i>
                            {allCorrectToday ? (
                                <p class="text-sm font-bold text-center text-navy dark:text-gold leading-relaxed">حركاتك 😉 لقد أجبت بشكل صحيح على جميع أسئلة اليوم!</p>
                            ) : (
                                <p class="text-sm   text-center text-navy dark:text-gray-200 leading-relaxed">أحسنت! أكملت أسئلة اليوم. حاول غداً لتحقيق الدرجة الكاملة! 🌟</p>
                            )}
                        </div>

                        <div class="mt-3 w-full pt-3 border-t border-gray-100 dark:border-white/5 flex flex-col items-center">
                            <h4 class="text-[11px]   text-gray-400 mb-2 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="award" class="w-3 h-3"></i> نقاطك التي حققتها
                            </h4>
                            <div class="inline-flex items-center gap-3 px-4 py-1.5 bg-gold/10 border border-gold/20 rounded-full shadow-sm">
                                <span class="text-[11px] font-bold text-navy dark:text-gold">{totalScore} نقطة  </span>
                            </div>
                        </div>
                    </div>
                );
            }

            const q = QUIZ_DATABASE[quizState.currentIndex];
            if (!q) return null;

            return (
                <div class="glass-card p-4 rounded-xl shadow-sm border border-navy/5 dark:border-white/5 overflow-hidden">
                    {/* Timer Bar */}
                    {!quizState.feedbackGiven && timerEnabled && (
                        <div class="absolute top-0 left-0 h-1 bg-gold/30 w-full z-10">
                            <div
                                class="h-full bg-gold transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(255,183,77,0.5)]"
                                style={{ width: `${(timeLeft / 10) * 100}%` }}
                            ></div>
                        </div>
                    )}

                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-800 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs bg-gold text-navy font-bold px-3 py-1 rounded-full shadow-sm">سؤال {quizState.answeredToday + 1}/5</span>
                            {!quizState.feedbackGiven && timerEnabled && (
                                <span class={`text-[10px] font-black tabular-nums py-1 px-2 rounded-lg ${timeLeft <= 3 ? 'bg-red-500 text-white animate-pulse' : 'bg-navy/5 dark:bg-white/5 text-navy dark:text-gold'}`}>
                                    {timeLeft}ث
                                </span>
                            )}
                        </div>

                        {/* Timer Toggle */}
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-gray-400">{timerEnabled ? 'تحدي' : 'استرخاء'}</span>
                            <button
                                onClick={() => { setTimerEnabled(!timerEnabled); triggerHaptic('light'); }}
                                class={`w-8 h-4 rounded-full relative transition-colors duration-300 ${timerEnabled ? 'bg-gold' : 'bg-gray-200 dark:bg-white/10'}`}
                            >
                                <div class={`absolute top-0.5 w-3 h-3 rounded-full bg-white shadow-sm transition-transform duration-300 ${timerEnabled ? 'left-4.5' : 'left-0.5'}`}></div>
                            </button>
                            <i data-lucide="timer" class={`w-4 h-4 ${timerEnabled ? 'text-gold' : 'text-gray-300'}`}></i>
                        </div>
                    </div>

                    <p class="text-sm md:text-base font-bold text-navy dark:text-white mb-5 text-right leading-relaxed">{q.question}</p>

                    <div class="grid grid-cols-2 gap-3">
                        {q.options.map((opt, idx) => {
                            const isCorrect = opt === q.correct;
                            let btnClass = "w-full text-xs py-4 rounded-xl transition-all duration-300 font-medium text-right px-4 border-2 "; // Increased padding

                            if (quizState.feedbackGiven) {
                                if (isCorrect) {
                                    btnClass += "bg-emerald/10 border-emerald text-emerald shadow-sm scale-105 z-10";
                                } else {
                                    btnClass += "bg-gray-50 dark:bg-white/5 border-transparent text-gray-400 opacity-50";
                                }
                            } else {
                                btnClass += "bg-white dark:bg-white/10 border-gray-100 dark:border-gray-800 text-gray-700 dark:text-gray-200 hover:border-gold/50 hover:bg-gold/5 active:scale-95";
                            }

                            return (
                                <button
                                    key={idx}
                                    onClick={() => onAnswer(isCorrect)}
                                    disabled={quizState.feedbackGiven}
                                    className={btnClass}
                                >
                                    <div className="flex flex-col">
                                        <span>{opt}</span>
                                        {quizState.feedbackGiven && isCorrect && !quizState.lastAnswerCorrect && (
                                            <span className="text-[9px] font-bold text-emerald-600 mt-1">(الإجابة الصحيحة)</span>
                                        )}
                                    </div>
                                </button>
                            );
                        })}
                    </div>

                    {quizState.feedbackGiven && (
                        <div class="mt-5 flex justify-between items-center bg-gray-50 dark:bg-white/5 p-2 rounded-lg animate-in fade-in slide-in-from-bottom-2">
                            <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${quizState.lastAnswerCorrect ? 'bg-emerald' : 'bg-red-500'} animate-pulse`}></div>
                                <span class={`text-xs font-bold ${quizState.lastAnswerCorrect ? 'text-emerald' : 'text-red-500'}`}>
                                    {quizState.lastAnswerCorrect ? 'إجابة عبقرية! ✓' : 'للأسف خطأ ✗'}
                                </span>
                            </div>
                            <button onClick={onNext} class="text-xs bg-navy dark:bg-gold text-white dark:text-navy px-6 py-2 rounded-xl font-bold shadow-md hover:scale-105 transition-transform">
                                التالي
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // -------------------- 💧 متتبع الماء الذكي (قفل وقت الصيام) --------------------
        const HydrationTrackerV3 = ({ hijriDay = 12 }) => {
            const [cups, setCups] = useState(0);
            const [showWarning, setShowWarning] = useState(false);
            const totalCups = 8;

            const tipIndex = (hijriDay - 1) % HYDRATION_TIPS.length;
            const dailyTip = HYDRATION_TIPS[tipIndex];

            const checkIsAllowed = () => {
                const now = new Date();
                const currentMin = now.getHours() * 60 + now.getMinutes();
                const maghribMin = 18 * 60 + 30; // 18:30
                const fajrMin = 5 * 60;        // 05:00
                return (currentMin >= maghribMin) || (currentMin < fajrMin);
            };

            const handleCupClick = (index) => {
                if (!checkIsAllowed()) {
                    setShowWarning(true);
                    triggerHaptic('medium');
                    return;
                }
                triggerHaptic('medium');
                if (index + 1 === totalCups && cups !== totalCups) triggerConfetti(false);
                setCups(index + 1);
            };

            return (
                <div class="glass-card p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex flex-col">
                            <h3 class="text-sm font-bold text-navy flex items-center gap-2">
                                <i data-lucide="droplet" class="w-4 h-4 text-blue-500"></i>
                                حفاظاً على رطوبة جسدك
                            </h3>
                            {/* 💧 فكرة 6: رؤى الهيدرات */}
                            <p class="text-[10px] text-gray-400 font-medium">
                                {cups >= 8 ? 'مستوى ترطيب مثالي! أحسنت 🌟' : cups >= 4 ? 'جيد، استمر في شرب الماء بانتظام 💧' : 'تذكر شرب الماء لتجنب الصداع 🥤'}
                            </p>
                        </div>
                        <div class="text-xs font-medium text-navy bg-blue-50 py-1 px-3 rounded-full border border-blue-100">
                            {cups}/{totalCups} أكواب
                        </div>
                    </div>
                    <div class="flex gap-4 items-stretch min-h-[130px]">
                        {/* القسم الأيمن: الكؤوس (60%) */}
                        <div class="w-[50%] border-l border-gray-100 pl-2 flex flex-col justify-center">
                            <div class="grid grid-cols-4 gap-2 justify-items-center">
                                {[...Array(totalCups)].map((_, i) => (
                                    <button
                                        key={i}
                                        onClick={() => handleCupClick(i)}
                                        class={`relative w-6 h-10 rounded-b-md border-2 border-t-0 overflow-hidden transition-all duration-300 shadow-sm ${i < cups
                                            ? 'border-serenity bg-serenity/10 scale-105 shadow-serenity/20'
                                            : 'border-gray-200 bg-serenity/5 hover:border-serenity/50'
                                            }`}
                                    >
                                        <div class={`absolute bottom-0 left-0 w-full bg-serenity transition-all duration-700 cup-content ${i < cups ? 'h-full opacity-100' : 'h-0 opacity-0'
                                            }`}>
                                            <div class="absolute top-0 left-0 w-full h-1 bg-white/30"></div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <p class="text-[10px] text-gray-400 mt-3 text-center">أكمل 8 أكواب يومياً</p>
                        </div>

                        {/* القسم الأيسر: المعلومة (40%) */}
                        <div class="w-[50%] flex flex-col justify-center gap-2 py-1 text-right">
                            <p class="text-[13px] text-gray-600 leading-[1.7]">
                                {dailyTip}
                            </p>
                        </div>
                    </div>

                    {/* Custom Popup for Fasting Warning */}
                    {showWarning && (
                        <div class="absolute inset-0 z-50 flex items-center justify-center p-3 rounded-xl bg-white/80 backdrop-blur-sm animate-fade-in">
                            <div class="bg-white border-2 border-red-500/30 rounded-xl p-4 shadow-2xl text-center relative max-w-[240px]">
                                <button onClick={() => setShowWarning(false)} class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-lg">✕</button>
                                <i data-lucide="alert-circle" class="w-8 h-8 mx-auto text-red-500 mb-2"></i>
                                <p class="text-[13px] font-black text-navy leading-relaxed">
                                    الفاطر فطروا بطنه 😂<br />
                                    <span class="text-[11px] font-medium text-gray-500">لا تنس شرب جرعتك من الماء ليلاً</span>
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // -------------------- 📜 التذييل والإهداء --------------------
        const FooterCredit = () => {
            useEffect(() => { lucide.createIcons(); });
            return (
                <div class="mt-8 mb-14 pt-6 border-t border-gray-200 dark:border-gray-800 text-center flex flex-col gap-1">
                    <h3 class="text-[19px] font-bold text-navy dark:text-gold uppercase tracking-widest">تطبيق خُطىْ</h3>
                    <p class="text-[13px] mb-2 text-gray-500 dark:text-gray-400 font-medium">تطوير صدام أحمد</p>
                    <p class="text-[13px] text-gray-400 dark:text-gray-500 mb-2 flex items-center justify-center gap-1">
                        أخبرني عن رأيك في التطبيق وكذلك ملاحظاتك <i data-lucide="smile" class="w-3 h-3 inline"></i>
                    </p>
                    <div class="flex justify-center gap-4">
                        <a href="https://wa.me/967777967272?text=أنا%20من%20مستخدمي%20تطبيق%20خطىٰ%20وتقييمي%20للتطبيق%20هو%20:%20" target="_blank" class="flex items-center gap-1.5 px-4 py-1.5 bg-emerald/10 text-emerald rounded-full text-[10px] font-bold hover:bg-emerald/20 transition">
                            <i data-lucide="message-circle" class="w-3.5 h-3.5"></i> واتساب
                        </a>
                        <a href="https://facebook.com/share/1FyLQYp6ne/?mibextid=wwXIfr" target="_blank" class="flex items-center gap-1.5 px-4 py-1.5 bg-navy/10 text-navy dark:bg-gold/10 dark:text-gold rounded-full text-[10px] font-bold hover:bg-navy/20 dark:hover:bg-gold/20 transition">
                            <i data-lucide="facebook" class="w-3.5 h-3.5"></i> فيسبوك
                        </a>
                    </div>
                </div>
            );
        };

        // -------------------- 🚀 MAIN APP V3.0 --------------------
        function App() {
            const [mounted, setMounted] = useState(false);
            const [tasbihCount, setTasbihCount] = useState(0);
            const [streak, setStreak] = useState(() => parseInt(localStorage.getItem('habitStreakV3')) || 0);
            const [userName, setUserName] = useState(() => localStorage.getItem('userNameV3') || '');

            // Onboarding
            const [onboardingSeen, setOnboardingSeen] = useState(() => localStorage.getItem('onboardingV3') === 'true');
            const [showOnboarding, setShowOnboarding] = useState(!onboardingSeen);

            // خطة القرآن
            const hijriDay = 12; // اليوم الحالي من رمضان (يُفضل ربطها بـ API لاحقاً)
            const [quranPlan, setQuranPlan] = useState(() => {
                const saved = localStorage.getItem('quranPlanV3');
                return saved ? JSON.parse(saved) : null;
            });

            // المتتبع اليومي
            const [additionalHabits, setAdditionalHabits] = useState(() => {
                const saved = localStorage.getItem('additionalHabitsV3');
                return saved ? JSON.parse(saved) : []; // {id, label, icon}
            });
            const [trackerItems, setTrackerItems] = useState([]);
            const [isLongPressGlobal, setIsLongPressGlobal] = useState(false);

            // حالة الأسئلة
            const [quizHistory, setQuizHistory] = useState(() => {
                const saved = localStorage.getItem('quizHistoryV3');
                return saved ? JSON.parse(saved) : {};
            });


            const [quizState, setQuizState] = useState(() => {
                const saved = localStorage.getItem('quizStateV3');
                const today = new Date().toDateString();
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.date !== today) {
                        return {
                            date: today,
                            answeredToday: 0,
                            correctToday: 0,
                            currentIndex: (hijriDay - 1) * 5,
                            feedbackGiven: false,
                            lastAnswerCorrect: null,
                            dailyComplete: false,
                            allCorrectToday: false
                        };
                    }
                    return parsed;
                }
                return {
                    date: today,
                    answeredToday: 0,
                    correctToday: 0,
                    currentIndex: (hijriDay - 1) * 5,
                    feedbackGiven: false,
                    lastAnswerCorrect: null,
                    dailyComplete: false,
                    allCorrectToday: false
                };
            });

            // تحديث trackerItems حسب additionalHabits + الصلوات الخمس
            useEffect(() => {
                const base = [
                    { id: 'fajr', label: 'الفجر', completed: false, icon: 'sunrise', isAdditional: false },
                    { id: 'dhuhr', label: 'الظهر', completed: false, icon: 'sun', isAdditional: false },
                    { id: 'asr', label: 'العصر', completed: false, icon: 'cloud-sun', isAdditional: false },
                    { id: 'maghrib', label: 'المغرب', completed: false, icon: 'sunset', isAdditional: false },
                    { id: 'isha', label: 'العشاء', completed: false, icon: 'moon', isAdditional: false }
                ];
                const extra = additionalHabits.map(h => ({ ...h, completed: false, isAdditional: true }));
                setTrackerItems([...base, ...extra]);
            }, [additionalHabits]);

            // 🏅 فكرة 7: أوسمة الاستمرارية (Streak Logic)
            useEffect(() => {
                const allDone = trackerItems.length > 0 && trackerItems.every(i => i.completed);
                if (allDone) {
                    const lastDate = localStorage.getItem('lastStreakDate');
                    const today = new Date().toDateString();
                    if (lastDate !== today) {
                        setStreak(prev => prev + 1);
                        localStorage.setItem('lastStreakDate', today);
                        localStorage.setItem('habitStreakV3', (streak + 1).toString());
                    }
                }
            }, [trackerItems]);

            // استرجاع البيانات من Dexie
            useEffect(() => {
                const loadData = async () => {
                    const tasbih = await db.appState.get("tasbih");
                    if (tasbih) setTasbihCount(tasbih.value);

                    const progress = await db.appState.get("allDaysProgress");
                    if (progress) setAllDaysProgress(progress.value);

                    const habits = await db.appState.get("additionalHabits");
                    if (habits) setAdditionalHabits(habits.value);

                    const quran = await db.appState.get("quranPlan");
                    if (quran) setQuranPlan(quran.value);
                };
                loadData();
            }, []);

            // حفظ الحالات إلى Dexie
            useEffect(() => { db.appState.put({ id: 'tasbih', value: tasbihCount }); }, [tasbihCount]);
            useEffect(() => { db.appState.put({ id: 'additionalHabits', value: additionalHabits }); }, [additionalHabits]);
            useEffect(() => { db.appState.put({ id: 'quranPlan', value: quranPlan }); }, [quranPlan]);
            useEffect(() => { localStorage.setItem('quizHistoryV3', JSON.stringify(quizHistory)); }, [quizHistory]);
            useEffect(() => { localStorage.setItem('quizStateV3', JSON.stringify(quizState)); }, [quizState]);


            useEffect(() => {
                document.documentElement.classList.remove('dark');
                lucide.createIcons();
                setMounted(true);
            }, []);

            // Onboarding close
            const closeOnboarding = (name) => {
                if (name) {
                    setUserName(name);
                    localStorage.setItem('userNameV3', name);
                }
                setShowOnboarding(false);
                setOnboardingSeen(true);
                localStorage.setItem('onboardingV3', 'true');
            };

            const handleUpdateName = () => {
                const newName = prompt('أدخل اسمك الجديد:', userName);
                if (newName !== null) {
                    const trimmed = newName.trim();
                    setUserName(trimmed);
                    localStorage.setItem('userNameV3', trimmed);
                }
            };

            // معالجة إضافة عادة جديدة
            const handleAddHabit = (type) => {
                triggerHaptic('light');
                const id = type === 'taraweeh' ? 'taraweeh' : 'qiyam';
                const label = type === 'taraweeh' ? 'تراويح' : 'قيام';
                const icon = type === 'taraweeh' ? 'star' : 'moon-star';

                if (additionalHabits.find(h => h.id === id)) {
                    setAdditionalHabits(prev => prev.filter(h => h.id !== id));
                } else {
                    setAdditionalHabits(prev => [...prev, { id, label, icon }]);
                }
            };

            const handleRemoveHabit = (id) => {
                setAdditionalHabits(prev => prev.filter(h => h.id !== id));
                triggerHaptic('medium');
            };

            const handleToggleItem = (id) => {
                setTrackerItems(prev => prev.map(item =>
                    item.id === id ? { ...item, completed: !item.completed } : item
                ));
            };

            // 🧠 منطق المسابقة
            const handleQuizAnswer = (isCorrect) => {
                if (quizState.feedbackGiven) return;
                const newState = { ...quizState, feedbackGiven: true, lastAnswerCorrect: isCorrect };
                if (isCorrect) newState.correctToday = quizState.correctToday + 1;
                setQuizState(newState);
                triggerHaptic(isCorrect ? 'success' : 'medium');
            };

            const handleNextQuestion = () => {
                let newAnswered = quizState.answeredToday + 1;
                let newComplete = newAnswered >= 5;
                let sessionCorrect = quizState.correctToday + (quizState.lastAnswerCorrect ? 1 : 0);
                let newAllCorrect = sessionCorrect >= 5;

                if (newComplete) {
                    setQuizHistory(prev => ({ ...prev, [hijriDay]: sessionCorrect }));
                    if (newAllCorrect) triggerConfetti(true);
                }

                setQuizState({
                    date: new Date().toDateString(),
                    answeredToday: newComplete ? 0 : newAnswered,
                    correctToday: newComplete ? 0 : sessionCorrect,
                    currentIndex: (hijriDay - 1) * 5 + (newComplete ? 0 : newAnswered),
                    feedbackGiven: false,
                    lastAnswerCorrect: null,
                    dailyComplete: newComplete,
                    allCorrectToday: newAllCorrect
                });
            };

            if (!mounted) return null;

            return (
                <div class="min-h-screen px-4 py-6 font-sans flex flex-col gap-5 relative overflow-hidden max-w-[768px] mx-auto">
                    {showOnboarding && <OnboardingModal onClose={closeOnboarding} />}

                    {/* الهوية البصرية - خُطىْ */}
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <img src="logo.jpg" alt="خُطىْ" class="w-12 h-12 rounded-full shadow-lg border-2 border-white/30 object-cover" />
                            <div>
                                <h1 class="text-2xl font-black text-navy dark:text-white leading-tight">خُطىْ</h1>
                                <p class="text-[13px] text-gray-500 dark:text-gray-500  ">مفكرة رمضانية</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <button onClick={handleUpdateName} class="flex items-center gap-2 bg-navy/5 px-3 py-1 rounded-full border border-navy/10 relative transition-transform active:scale-95">
                                <i data-lucide="user" class="w-3.5 h-3.5 text-navy"></i>
                                {userName && <span class="text-[11px] font-bold text-navy">{userName}</span>}
                                {streak > 0 && (
                                    <div class="absolute -top-2 -right-2 bg-orange-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full shadow-sm animate-pulse border border-white">
                                        {streak} 🔥
                                    </div>
                                )}
                            </button>
                            {(() => {
                                const totalScore = Object.values(quizHistory).reduce((a, b) => a + b, 0);
                                let title = "مبتدئ شغوف 🌱";
                                let color = "text-gray-400";
                                if (totalScore > 110) { title = "عالم المسابقة ⭐"; color = "text-gold"; }
                                else if (totalScore > 70) { title = "موسوعة خُطىْ 🧠"; color = "text-navy"; }
                                else if (totalScore > 30) { title = "باحث رمضاني 📖"; color = "text-emerald-600"; }
                                return <span class={`text-[9px] font-medium uppercase tracking-tighter ${color}`}>{title}</span>;
                            })()}
                        </div>
                    </div>

                    {/* الهيدر + الصلاة - تم نقله ليكون الأول */}
                    <SmartLunarHeader hijriDay={12} />

                    {/* ويدجت الحكمة */}
                    <WisdomWidget hijriDay={12} />

                    {/* المتتبع اليومي */}
                    <DailyTrackerV3
                        items={trackerItems}
                        onItemToggle={handleToggleItem}
                        onAddHabit={handleAddHabit}
                        onRemoveHabit={handleRemoveHabit}
                        isLongPressMode={isLongPressGlobal}
                        longPressActive={setIsLongPressGlobal}
                    />

                    {/* الورد القرآني المتقدم */}
                    <QuranAdvanced plan={quranPlan} onSetup={(plan) => setQuranPlan(plan)} />

                    {/* بصمة الخير */}
                    <PersonalReflectionWidget userName={userName} />

                    {/* المسابقة الذكية */}
                    <SmartQuiz
                        quizState={quizState}
                        quizHistory={quizHistory}
                        onAnswer={handleQuizAnswer}
                        onNext={handleNextQuestion}
                        isDailyComplete={quizState.dailyComplete}
                        allCorrectToday={quizState.allCorrectToday}
                        hijriDay={hijriDay}
                    />

                    {/* متتبع الماء (بعد المسابقة) */}
                    <HydrationTrackerV3 hijriDay={hijriDay} />


                    {/* التذييل والإهداء */}
                    <FooterCredit />

                    {/* سبحة عائمة */}
                    <button
                        onClick={() => { setTasbihCount(p => p + 1); triggerHaptic('light'); }}
                        class="fixed bottom-6 left-6 w-16 h-16 bg-navy dark:bg-gold rounded-full shadow-2xl flex items-center justify-center z-50 active:scale-90 transition-transform border-4 border-white/20 dark:border-navy/20 animate-pulse-gold"
                    >
                        <div class="text-center">
                            <span class="block text-[10px] font-bold text-white/70 dark:text-navy/70">سبّح</span>
                            <span class="block text-lg font-bold text-gold dark:text-navy">{tasbihCount}</span>
                        </div>
                    </button>

                    {/* زر المصحف العائم */}
                    <a
                        href="quran.html"
                        class="fixed bottom-6 right-6 w-16 h-16 bg-navy text-white rounded-full shadow-2xl flex flex-col items-center justify-center z-50 active:scale-90 transition-transform border-4 border-white/20"
                    >
                      
                        <span class="text-[10px] font-bold ">المصحف</span>
                    </a>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>