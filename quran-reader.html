<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿÆŸèÿ∑ŸâŸí V3.0 | ÿßŸÑŸÇÿßÿ±ÿ¶</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                        serif: ['Amiri', 'serif'],
                    },
                    colors: {
                        navy: '#1e3a8a',
                        gold: '#fbbf24',
                        'oled-black': '#000000',
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .reader-paper { background-color: #fdf6e3; }
        .dark .reader-oled { background-color: #000000; }
        .aya-ornament { font-family: 'Amiri', serif; }

        /* Smooth Snapping */
        .scroll-container {
            scroll-snap-type: y proximity;
        }
        .aya-item {
            scroll-snap-align: start;
        }

        .modal-backdrop {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-white dark:bg-black text-slate-800 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // -------------------- üóÑÔ∏è DATABASE --------------------
        const db = new Dexie("RamadanPlannerDB");
        db.version(2).stores({
            appState: "id, value",
            dailyProgress: "day, data",
            quran_text: "++id, sura, aya",
            reflections: "++id, [sura+aya]"
        });

        // -------------------- üíæ HELPER FUNCTIONS --------------------
        const triggerConfetti = (fullScreen = false) => {
            if (fullScreen) {
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.5 }, colors: ['#fbbf24', '#1e3a8a', '#10b981'] });
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.5, x: 0.2 }, colors: ['#f97316', '#312e81'] });
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.5, x: 0.8 }, colors: ['#10b981', '#fbbf24'] });
            } else {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#1e3a8a', '#10b981'] });
            }
        };

        const triggerHaptic = (style = 'light') => {
            if (navigator.vibrate) {
                if (style === 'light') navigator.vibrate(10);
                if (style === 'medium') navigator.vibrate(20);
                if (style === 'heavy') navigator.vibrate([30, 50, 30]);
                if (style === 'success') navigator.vibrate([10, 30, 10, 30]);
            }
        };

        // -------------------- üìä DATA CONSTANTS --------------------
        const JUZ_MAPPING = [
            { juz: 1, sura: 1, aya: 1 }, { juz: 2, sura: 2, aya: 142 }, { juz: 3, sura: 2, aya: 253 },
            { juz: 4, sura: 3, aya: 93 }, { juz: 5, sura: 4, aya: 24 }, { juz: 6, sura: 4, aya: 148 },
            { juz: 7, sura: 5, aya: 82 }, { juz: 8, sura: 6, aya: 111 }, { juz: 9, sura: 7, aya: 88 },
            { juz: 10, sura: 8, aya: 41 }, { juz: 11, sura: 9, aya: 93 }, { juz: 12, sura: 11, aya: 6 },
            { juz: 13, sura: 12, aya: 53 }, { juz: 14, sura: 15, aya: 1 }, { juz: 15, sura: 17, aya: 1 },
            { juz: 16, sura: 18, aya: 75 }, { juz: 17, sura: 21, aya: 1 }, { juz: 18, sura: 23, aya: 1 },
            { juz: 19, sura: 25, aya: 21 }, { juz: 20, sura: 27, aya: 56 }, { juz: 21, sura: 29, aya: 45 },
            { juz: 22, sura: 33, aya: 31 }, { juz: 23, sura: 36, aya: 28 }, { juz: 24, sura: 39, aya: 32 },
            { juz: 25, sura: 41, aya: 47 }, { juz: 26, sura: 46, aya: 1 }, { juz: 27, sura: 51, aya: 31 },
            { juz: 28, sura: 58, aya: 1 }, { juz: 29, sura: 67, aya: 1 }, { juz: 30, sura: 78, aya: 1 }
        ];

        const SAJDAH_LIST = [
            { sura: 7, aya: 206 }, { sura: 13, aya: 15 }, { sura: 16, aya: 50 },
            { sura: 17, aya: 109 }, { sura: 19, aya: 58 }, { sura: 22, aya: 18 },
            { sura: 22, aya: 77 }, { sura: 25, aya: 60 }, { sura: 27, aya: 26 },
            { sura: 32, aya: 15 }, { sura: 38, aya: 24 }, { sura: 41, aya: 38 },
            { sura: 53, aya: 62 }, { sura: 84, aya: 21 }, { sura: 96, aya: 19 }
        ];

        const getJuz = (sura, aya) => {
            for (let i = JUZ_MAPPING.length - 1; i >= 0; i--) {
                const j = JUZ_MAPPING[i];
                if (sura > j.sura || (sura === j.sura && aya >= j.aya)) {
                    return j.juz;
                }
            }
            return 1;
        };

        const isSajdah = (sura, aya) => {
            return SAJDAH_LIST.some(s => s.sura === sura && s.aya === aya);
        };

        // -------------------- üß© COMPONENTS --------------------
        const ReaderHeader = ({ currentAya, onBack }) => {
            useEffect(() => { lucide.createIcons(); });
            const juz = useMemo(() => getJuz(currentAya.sura, currentAya.aya), [currentAya]);

            return (
                <div class="sticky top-0 z-30 bg-white/90 dark:bg-black/90 backdrop-blur-md px-4 py-3 flex justify-between items-center border-b border-gray-200 dark:border-gray-800 shrink-0 shadow-sm">
                    <button onClick={onBack} class="p-2 -ml-2 text-navy dark:text-gold active:scale-90 transition">
                        <i data-lucide="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <div class="text-center">
                        <h2 class="font-serif text-lg font-bold text-navy dark:text-gold leading-tight">{currentAya.sura_name || 'ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ'}</h2>
                        <p class="text-[10px] text-gray-500 font-sans">ÿßŸÑÿ¨ÿ≤ÿ° {juz} ‚Ä¢ ÿ≥Ÿàÿ±ÿ© {currentAya.sura} ‚Ä¢ ÿ¢Ÿäÿ© {currentAya.aya}</p>
                    </div>
                    <button onClick={onBack} class="p-2 -mr-2 text-gray-400 hover:text-red-500 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            );
        };

        // -------------------- üöÄ MAIN COMPONENT --------------------
        const QuranReaderPage = () => {
            const [mounted, setMounted] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('darkMode') === 'true');
            const [ayas, setAyas] = useState([]);
            const [initStatus, setInitStatus] = useState('loading');
            const [currentAya, setCurrentAya] = useState({ sura: 1, aya: 1, sura_name: 'ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©' });

            const [visibleRange, setVisibleRange] = useState({ start: 0, end: 40 });
            const [fontSize, setFontSize] = useState(parseInt(localStorage.getItem('readerFontSize')) || 24);
            const [showSettings, setShowSettings] = useState(false);
            const [focusedAya, setFocusedAya] = useState(null);

            const observerRef = useRef(null);
            const containerRef = useRef(null);
            const pressTimer = useRef(null);

            useEffect(() => {
                const load = async () => {
                    try {
                        const count = await db.quran_text.count();
                        if (count === 0) {
                            window.location.href = 'index.html';
                            return;
                        }
                        const allAyas = await db.quran_text.toArray();
                        setAyas(allAyas);

                        const lr = await db.appState.get("lastRead");
                        let initialIdx = 0;
                        if (lr) {
                            setCurrentAya(lr.value);
                            initialIdx = allAyas.findIndex(a => a.sura === lr.value.sura && a.aya === lr.value.aya);
                        }

                        const start = Math.max(0, initialIdx - 5);
                        setVisibleRange({ start, end: start + 40 });

                        setTimeout(() => {
                            const target = document.getElementById(`aya-${lr?.value.sura || 1}-${lr?.value.aya || 1}`);
                            if (target) target.scrollIntoView({ behavior: 'auto', block: 'start' });
                        }, 300);

                        setInitStatus('ready');
                    } catch (err) {
                        console.error(err);
                        setInitStatus('error');
                    }
                };
                load();
                setMounted(true);
            }, []);

            useEffect(() => {
                observerRef.current = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const [_, sura, aya] = entry.target.id.split('-').map(Number);
                            const suraName = entry.target.dataset.suraName;
                            setCurrentAya({ sura, aya, sura_name: suraName });
                            db.appState.put({ id: 'lastRead', value: { sura, aya, sura_name: suraName } });

                            // Haptic Pulse for milestones
                            if (aya % 10 === 0) triggerHaptic('light');
                            if (isSajdah(sura, aya)) triggerHaptic('heavy');
                        }
                    });
                }, { threshold: 0.2, rootMargin: '-10% 0px -40% 0px' });

                return () => observerRef.current.disconnect();
            }, []);

            useEffect(() => {
                const elements = document.querySelectorAll('.aya-item');
                elements.forEach(el => observerRef.current.observe(el));
                return () => elements.forEach(el => observerRef.current.unobserve(el));
            }, [visibleRange, ayas]);

            const handleScroll = (e) => {
                const scrollTop = e.target.scrollTop;
                // Rough estimate of aya height is 150px
                const start = Math.max(0, Math.floor(scrollTop / 150) - 10);
                const end = Math.min(ayas.length, start + 50);
                if (Math.abs(start - visibleRange.start) > 10) {
                    setVisibleRange({ start, end });
                }
            };

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            useEffect(() => {
                localStorage.setItem('readerFontSize', fontSize);
            }, [fontSize]);

            if (!mounted || initStatus === 'loading') {
                return (
                    <div class="min-h-screen flex flex-col items-center justify-center p-6 text-center reader-paper dark:reader-oled transition-colors">
                        <div class="w-16 h-16 border-4 border-navy border-t-gold rounded-full animate-spin mb-4"></div>
                        <h2 class="text-xl font-bold text-navy dark:text-gold mb-2">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿµÿ≠ŸÅ...</h2>
                    </div>
                );
            }

            const handleLongPress = (aya) => {
                triggerHaptic('medium');
                setFocusedAya(aya);
            };

            const startPress = (aya) => {
                pressTimer.current = setTimeout(() => handleLongPress(aya), 600);
            };

            const cancelPress = () => {
                clearTimeout(pressTimer.current);
            };

            return (
                <div class="min-h-screen h-screen flex flex-col reader-paper dark:reader-oled transition-colors overflow-hidden">
                    <ReaderHeader
                        currentAya={currentAya}
                        onBack={() => window.location.href = 'index.html'}
                    />

                    <div
                        ref={containerRef}
                        onScroll={handleScroll}
                        class="flex-1 overflow-y-auto p-4 sm:p-8 font-serif text-right no-scrollbar scroll-container"
                    >
                        <div class="max-w-2xl mx-auto" style={{
                            paddingTop: visibleRange.start * 150,
                            paddingBottom: (ayas.length - visibleRange.end) * 150
                        }}>
                            {ayas.slice(visibleRange.start, visibleRange.end).map((aya) => (
                                <div
                                    key={`${aya.sura}-${aya.aya}`}
                                    id={`aya-${aya.sura}-${aya.aya}`}
                                    data-sura-name={aya.sura_name}
                                    onMouseDown={() => startPress(aya)}
                                    onMouseUp={cancelPress}
                                    onTouchStart={() => startPress(aya)}
                                    onTouchEnd={cancelPress}
                                    onClick={() => focusedAya && setFocusedAya(null)}
                                    class={`aya-item group relative transition-all duration-500 p-4 rounded-xl mb-12 border-b border-gold/5 ${
                                        focusedAya ? (focusedAya.id === aya.id ? 'opacity-100 scale-[1.02] bg-gold/5' : 'opacity-30 blur-[1px]') : 'opacity-100'
                                    }`}
                                >
                                    {aya.bismillah && (
                                        <div class="text-center mb-8 text-navy dark:text-gold opacity-90 py-4 font-serif" style={{ fontSize: fontSize * 1.2 }}>
                                            {aya.bismillah}
                                        </div>
                                    )}
                                    <div class="leading-[2.4] text-gray-800 dark:text-gray-100" style={{ fontSize: fontSize }}>
                                        {aya.text}
                                        <span class="inline-flex items-center justify-center min-w-[2.5rem] h-10 rounded-full border-2 border-gold/20 text-gold mx-4 font-sans align-middle text-sm">
                                            {aya.aya}
                                        </span>
                                    </div>
                                    <div class="flex justify-center mt-6 opacity-20">
                                        <div class="w-12 h-px bg-gold"></div>
                                        <div class="mx-2 text-[10px] text-gold">‚óà</div>
                                        <div class="w-12 h-px bg-gold"></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Floating Settings Button */}
                    <button
                        onClick={() => setShowSettings(true)}
                        class="fixed bottom-6 left-6 w-14 h-14 bg-navy dark:bg-gold text-white dark:text-navy rounded-full shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20"
                        aria-label="Settings"
                    >
                        <i data-lucide="type" class="w-6 h-6"></i>
                    </button>

                    {/* Font Settings Bottom Sheet */}
                    {showSettings && (
                        <div class="fixed inset-0 z-50 flex items-end justify-center modal-backdrop" onClick={() => setShowSettings(false)}>
                            <div
                                class="bg-white dark:bg-zinc-900 w-full max-w-md rounded-t-3xl p-6 shadow-2xl animate-slide-up"
                                onClick={e => e.stopPropagation()}
                            >
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-navy dark:text-gold">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©</h3>
                                    <button onClick={() => setShowSettings(false)} class="p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>

                                <div class="mb-8">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-xs text-gray-500">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑</span>
                                        <span class="font-bold text-navy dark:text-gold">{fontSize}px</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-sm font-bold">A-</span>
                                        <input
                                            type="range" min="16" max="48" value={fontSize}
                                            onChange={(e) => setFontSize(parseInt(e.target.value))}
                                            class="flex-1 accent-navy dark:accent-gold h-2 bg-gray-200 dark:bg-gray-800 rounded-lg appearance-none cursor-pointer"
                                        />
                                        <span class="text-xl font-bold">A+</span>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowSettings(false)}
                                    class="w-full bg-navy dark:bg-gold text-white dark:text-navy py-3 rounded-xl font-bold"
                                >
                                    ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ∫ŸÑÿßŸÇ
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuranReaderPage />);
    </script>
</body>
</html>
